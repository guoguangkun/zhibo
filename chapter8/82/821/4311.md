##4.3.1.1 分布式系统  

#### 1 什么是分布式系统 
####1.1 单机结构
大家最熟悉的就是单机结构，当一个系统业务量很小的时候所有的代码都放在一个项目中就好了，然后这个项目部署在一台服务器上。整个项目所有的服务都由这台服务器提供。这就是单机结构。显而易见的，单机的处理能力是有限的，当你的业务增长到一定程度的时候，单机的硬件资源将无法满足你的业务需求。此时便出现了集群模式。  
####1.2 集群结构
将单机复制几份，这样就构成了一个集群。集群中每台服务器就叫做这个集群的一个节点，每个节点都提供相同的服务，这样系统的处理能力就相当于提升了好几倍。但问题是用户的请求究竟由哪个节点来处理呢？最好能够让负载较小的节点来处理，这样使得每个节点的压力都比较平均。要实现这个功能，就需要在所有节点之前增加一个“调度者”的角色，用户的所有请求都先交给它，然后它根据当前所有节点的负载情况，决定将这个请求交给哪个节点处理。这个“调度者”有个响亮的名字——负载均衡服务器。集群结构的好处就是系统扩展非常容易。如果随着系统业务的发展，当前的系统又支撑不住了，那么给这个集群再增加节点就行了。但是，当你的业务发展到一定程度的时候，你会发现一个问题——无论怎么增加节点，似乎整个集群性能的提升效果并不明显了。这时候，你就需要使用微服务结构了。  
####1.3 分布式结构  
从单机结构到集群结构，你的代码基本无需要作任何修改，你要做的仅仅是多部署几台服务器，每台服务器上运行相同的代码。但是，当你要从集群结构演进到微服务结构的时候，之前的那套代码就需要发生较大的改动了。所以对于新系统我们建议，系统设计之初就采用微服务架构，这样后期运维的成本更低。分布式结构就是将一个完整的系统，按照业务功能，拆分成一个个独立的子系统，在分布式结构中，每个子系统就被称为“服务”。。在我们的直播系统开发过程中，按照微服务的思想，我们按照功能模块拆分成多个独立的服务，如：用户服务、拉流服务、存储服务、编解码服务等等。这一个个服务都是一个个独立的项目，可以独立运行。如果服务之间有依赖关系，那么通过RPC方式调用。这样的好处有很多：系统之间的耦合度大大降低，可以独立开发、独立部署、独立测试，系统与系统之间的边界非常明确，排错也变得相当容易，开发效率大大提升。我们可以针对性地扩展某些服务。假设某一时刻业务量突然暴增，我们可以针对性地提升拉流系统、编解码系统的节点数量，而对于后台用户系统、存储系统而言，节点数量维持原有水平即可。同时，各个服务的复用性更高。当我们将用户系统作为单独的服务后，公司所有的产品都可以使用该系统作为用户系统，无需重复开发。  
####2 CAP定理  
CAP定理指的是在一个分布式系统中， Consistency（一致性）、Availability（可用性）、Partition tolerance（分区容错性），三者不可得兼而最多取其二。我们先来看看这三个特性的含义。
#### 一致性（C）：在分布式系统中的所有数据备份，在同一时刻是否同样的值。
#### 可用性（A）：在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求。
#### 分区容忍性（P）：以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择。  
一个分布式系统里面，节点组成的网络本来应该是连通的。然而可能因为一些故障，使得有些节点之间不连通了，整个网络就分成了几块区域。数据就散布在了这些不连通的区域中。这就叫分区。  
当一个数据项只在一个节点中保存，那么分区出现后，和这个节点不连通的部分就访问不到这个数据了。这时分区就是无法容忍的。提高分区容忍性的办法就是一个数据项复制到多个节点上，那么出现分区之后，这一数据项就可能分布到各个区里。容忍性就提高了。
然而，要把数据复制到多个节点，就会带来一致性的问题，就是多个节点上面的数据可能是不一致的。要保证一致，每次写操作就都要等待全部节点写成功，而这等待又会带来可用性的问题。
总的来说就是，数据存在的节点越多，分区容忍性越高，但要复制更新的数据就越多，一致性就越难保证。为了保证一致性，更新所有节点数据所需要的时间就越长，可用性就会降低。  
CAP理论就是说在分布式系统中，我们最多只能实现CAP中的两点。


