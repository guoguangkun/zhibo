## 5.3 IJKplayer框架介绍

IJKplayer是Bilibili网站工程师基于FFmpeg及MediaCodec开发的开源播放器框架，内部实现了软解及硬解的功能，其基本框架如下图所示：
![](/assets/图5.3-1.png)
针对各种铺天盖地的播放器项目，我们选取了比较出众的IJKplayer进行源码剖析。它是一个基于FFPlay的轻量级Android/iOS视频播放器，实现了跨平台的功能，API易于集成；编译配置可裁剪，方便控制安装包大小。

### 一、结构说明
我们可以在GitHub下载或查看ijkplayer项目，地址是https://github.com/Bilibili/ijkplayer ，可看到其主要目录结构如下:

| 目录名称| 说明 |
| :--- | :--- | 
| tool| 初始化项目工程脚本|
| config| 编译ffmpeg使用的配置文件|
| extra| 存放编译ijkplayer所需的依赖源文件, 如ffmpeg、openssl等|
| ijkmedia| 核心代码|
| ijkplayer| 播放器数据下载及解码相关|
| ijksdl| 音视频数据渲染相关|
| ios| iOS平台上的上层接口封装以及平台相关方法|
| android| Android平台上的上层接口封装以及平台相关方法|

特性列表

| 特性名称| 说明 |
| :--- | :--- |
| Android平台| 支持API 9〜23|
| CPU | ARMv7a，ARM64v8a，x86（ARMv5未在真实设备上测试）|
| API | API提供丰富的方法，易于集成|
| 视频输出 | NativeWindow，OpenGL ES 2.0|
| 音频输出| AudioTrack，OpenSL ES|
| 编解码器| MediaCodec（API 16+，Android 4.1+），支持硬件加速解码，更加省电|
| 其他| 可替代android.media.MediaPlayer，ExoPlayer|
在功能的具体实现上，iOS和Android平台的差异主要表现在视频硬件解码以及音视频渲染方面，两者实现的载体区别如下表所示：

| Platform | Hardware Codec | Video Render | Audio Output |
| :--- | :--- | :--- | :--- |
| iOS | VideoToolBox | OpenGL ES | AudioQueue |
| Android | MediaCodec | OpenGL ES、MediaCodec | OpenSL ES、AudioTrack |

### 二、前期准备
开发前我们先给大家介绍一下，如何编译ijkplayer和ffmpeg。注意大家尽量不要用Windows下编译，各种想象不到编译不通过的Bug，这里我们以在Ubuntu下编译源码为例。首先必须安装需要安装homebrew, git, yasm三个软件,再次注意AndroidNDK必须安装，最好是r10-14版本内，不然编译可能会出错。
```code
# install homebrew, git, yasm
ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
brew install git
brew install yasm

# add these lines to your ~/.bash_profile or ~/.profile
# export ANDROID_SDK=<your sdk path>
# export ANDROID_NDK=<your ndk path>

# on Cygwin (unmaintained)
# install git, make, yasm
```
全部安装完成，在命令行继续一步步执行如下代码
```code
git clone https://github.com/Bilibili/ijkplayer.git ijkplayer-android
cd ijkplayer-android
git checkout -B latest k0.8.4

./init-android.sh

cd android/contrib
./compile-ffmpeg.sh clean
./compile-ffmpeg.sh all

cd ..
./compile-ijk.sh all
```
如果执行过程中没有任何问题，执行成功后我们可以到android文件夹下ijkplayer下，在对应的cpu项目中找到相应的.so文件了。







